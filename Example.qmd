---
title: "Bayesian Inference with a frugal parameterization"
author: "Gregor Steiner"
date: last-modified
editor: visual
theme: cosmo
toc: true  
number-sections: true
colorlinks: true
highlight-style: pygments
format:
  html: 
    code-fold: true
    code-tools: true
    html-math-method: katex
    self-contained: true
bibliography: references.bib
execute: 
  warning: false
  message: false
---

# Simulate Data

This notebook works through a simple example using the frugal parameterization proposed by @evans_didelez_2023 . First, we simulate data based on a simple model with an outcome $Y$, a binary treatment $X$, and a confounder $Z$. The setup is $$ Z \sim N(\mu_Z, \sigma_Z^2) \\
X | Z = z \sim Ber( \text{expit}(z)) \\
Y | \text{do}(X = x) \sim N(\beta x, \sigma^2).$$

The dependence between $Y$ and $Z$ is modeled using a Gaussian copula with correlation parameter $\phi_{YZ|X}^* = 2 \text{expit}(\alpha_{\phi} + \beta_{\phi} X) - 1$. Thus, the frugal parameterization consists of $\theta_{ZX} = (\mu_Z, \sigma_Z)$, $\theta_{Y|X}^* = (\beta, \sigma^2)$, and $\phi_{YZ|X}^* = (\alpha_\phi, \beta_\phi)$. The data is simulated with $\beta = 1$, $\sigma^2 = 1$, $\mu_Z = 1/2$, $\sigma_Z^2 = 4$, $\alpha_{\phi} = 0$, and $\beta_{\phi} = 1$.

```{r}
#devtools::install_github("rje42/causl")
library(causl)

forms <- list(Z ~ 1, 
              X ~ Z,
              Y ~ X, 
              ~ X)

pars <- list(Z = list(beta = 1/2, phi = 4),
             X = list(beta = c(0, 1)),
             Y = list(beta = c(0, 1), phi = 1),
             cop = list(beta = c(0, 1)))

set.seed(12)
n <- 1e3
dat <- rfrugalParam(n, formulas = forms, pars = pars, 
                    family = list(1, 5, 1, 1), careful = FALSE)


```

# Maximum Likelihood

We perform maximum likelihood estimation as described in @evans_didelez_2023 . The observational likelihood is given by \begin{align*}
    p_{ZXY}(z, x, y | \theta^*) &= p_{ZX}(z, x | \theta_{ZX}) p_{Y|ZX}^*(y|z, x; \theta_{Y|X}^*, \phi_{YZ | X}^*) \\
    &= p_{ZX}(z, x | \theta_{ZX}) p_{Y|X}^*(y | x; \theta_{Y|X}^*) c(y, z| x; \phi_{YZ | X}^*),
\end{align*} where $c(y, z| x; \phi_{YZ | X}^*)$ is a copula density. By substituting $p_{ZX}$ for the causal distribution $p_{ZX}^*$, where $Z$ and $X$ are independent, we obtain the causal likelihood. Now, we can maximise the causal likelihood w.r.t. the observational data to obtain an estimate for $\beta$. This is done below using the implementation by Robin Evans.

```{r}
fit <- fitCausal(dat, formulas = list(Y ~ X, Z ~ 1, ~ X),
                 family = c(1, 1, 1), control=list(maxit=2e4, newton=TRUE))
fit
```

The estimate is close to the true value of 1. For comparison, we can also perform a naive outcome regression, where we obtain a confidence interval for $\beta_X$ excluding the true value of 1.

```{r}
lm(Y ~ X, data = dat) |> confint()
```

# Bayesian Approach


Here, we try a fully Bayesian approach using normal priors for the location parameters and exponential priors for the scale parameters.

```{r}
library(rstan)
options(mc.cores = parallel::detectCores())
library(bayesplot)

fit = stan("example.stan", data = list(
  "N" = nrow(dat),
  "Y" = dat$Y,
  "X" = dat$X,
  "Z" = dat$Z
), iter = 2000, warmup = 1000)


mcmc_hist(fit)

```


# Different choices of $\eta$

Above, we implicitly used $p_{ZX}^* = p_Z \cdot p_X^*$, where $p_X^*$ is the causal distribution of $X$ (independent of Z) and parameterized this by $\theta_{ZX} = (\mu_Z, \sigma_Z)$. What happens if one uses a different parameterization of $p_{ZX}^*$, e.g. we could use $\eta(\theta_{ZX}) = (\eta_1, \eta_2) = (\mu_Z / \sigma_Z, 1 / \sigma_Z^2)$? In this parameterization, one has $Z \sim N(\eta_1 / \sqrt{\eta_2}, 1/\sqrt{\eta_2})$ and we put a normal prior on $\eta_1$ and an exponential prior on $\eta_2$.

```{r}
fit_eta = stan("example_eta.stan", data = list(
  "N" = nrow(dat),
  "Y" = dat$Y,
  "X" = dat$X,
  "Z" = dat$Z
), iter = 2000, warmup = 1000)



mcmc_hist(fit_eta)

```



